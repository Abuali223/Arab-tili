<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lingua Trio ‚Äî Arabic ‚Ä¢ English ‚Ä¢ O‚Äòzbek</title>
  <meta name="description" content="Arabic‚ÄìEnglish‚ÄìUzbek language learning with SRS flashcards, quiz, and speech." />
  <style>
    :root{
      --bg: #0b1220;
      --panel: #111a2b;
      --muted: #7c8aa5;
      --text: #e6edf7;
      --brand: #4f8cff;
      --accent: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --card: #0f172a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, #060a14, #0b1220 30%, #0b1220);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(8px);
      background: rgba(6,10,20,.6);
      border-bottom: 1px solid #18223a;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 18px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .logo{display:flex;gap:10px;align-items:center;font-weight:700;letter-spacing:.3px}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--brand);box-shadow:0 0 12px var(--brand)}
    .pill{
      background:#0d1629;border:1px solid #1a2947;color:var(--text);
      border-radius:999px;padding:8px 12px;display:inline-flex;gap:10px;align-items:center
    }
    select,button,input[type="file"]{
      background:#0d1629;border:1px solid #213151;color:var(--text);
      border-radius:10px;padding:10px 12px;
    }
    button{cursor:pointer;transition:.15s transform ease,.15s background ease}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    main{padding:24px 18px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{
      background:var(--panel);
      border:1px solid #1a2947;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h2{margin:0 0 12px 0;font-size:20px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{
      background:#0d1629;border:1px solid #213151;border-radius:14px;
      padding:10px 12px;min-width:110px
    }
    .muted{color:var(--muted)}
    .card{
      background:var(--card);border:1px solid #1b2845;border-radius:18px;
      padding:26px;min-height:220px;display:flex;flex-direction:column;justify-content:center;gap:14px
    }
    .big{
      font-size:clamp(26px,4vw,40px);
      line-height:1.25;
      word-break:break-word;
    }
    .xbig{font-size:clamp(20px,3vw,28px);color:#a6b3cc}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls .spacer{flex:1}
    .rowcenter{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .btn{
      padding:12px 14px;border-radius:12px;border:1px solid #223357;background:#0f1a31;
    }
    .btn.brand{background:linear-gradient(180deg,#3f7df0,#4f8cff);border-color:#3f7df0}
    .btn.accent{background:linear-gradient(180deg,#17b968,#22c55e);border-color:#17b968}
    .btn.warn{background:linear-gradient(180deg,#f59e0b,#fbbf24);border-color:#f59e0b;color:#1b1300}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#f87171);border-color:#ef4444}
    .btn.ghost{background:#0d1629}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:12px;color:#a6b3cc;background:#0b1427;border:1px solid #213151;border-radius:999px;padding:4px 8px}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .item{padding:12px;border:1px solid #213151;border-radius:12px;background:#0f172a}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background:#0d1629;border:1px solid #223357;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
    .footer{color:var(--muted);font-size:13px;margin-top:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .divider{height:1px;background:#223357;margin:16px 0}
    .right{justify-self: end}
    .success{color:var(--accent)}
    .danger-t{color:#ff7b7b}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="logo"><span class="dot" aria-hidden="true"></span> Lingua Trio</div>
      <div class="pill grow" role="group" aria-label="Study direction">
        <span id="lblFrom" class="muted" style="min-width:70px;display:inline-block">From</span>
        <select id="fromLang" aria-label="From language">
          <option value="uz">O‚Äòzbek</option>
          <option value="en">English</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
        <span class="muted">‚Üí</span>
        <select id="toLang" aria-label="To language">
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="en">English</option>
          <option value="uz">O‚Äòzbek</option>
        </select>
      </div>
      <div class="pill" role="group" aria-label="UI language">
        <span class="muted" id="lblUi">UI</span>
        <select id="uiLang" aria-label="Interface language">
          <option value="uz" selected>O‚Äòzbek</option>
          <option value="en">English</option>
          <option value="tr">T√ºrk√ße</option>
        </select>
      </div>
      <button id="btnExport" class="btn ghost" title="Backup (JSON)">‚¨áÔ∏è Export</button>
      <label class="btn ghost" for="imp" title="Restore (JSON)">‚¨ÜÔ∏è Import</label>
      <input id="imp" type="file" accept="application/json" class="sr-only" />
    </div>
  </header>

  <main class="wrap grid" id="appRoot">
    <section class="panel">
      <h2 id="hFlash">Flashcards (SRS)</h2>
      <div class="stats" role="status">
        <div class="stat"><div class="muted" id="sDueL">Due</div><div class="big" id="sDue">0</div></div>
        <div class="stat"><div class="muted" id="sNewL">New</div><div class="big" id="sNew">0</div></div>
        <div class="stat"><div class="muted" id="sLearnedL">Learned</div><div class="big" id="sLearned">0</div></div>
        <div class="stat"><div class="muted" id="sAccL">Accuracy</div><div class="big" id="sAcc">‚Äî</div></div>
      </div>

      <div class="divider"></div>

      <article class="card" id="card" aria-live="polite">
        <div class="tags">
          <span class="tag" id="tagCategory">basic</span>
          <span class="tag" id="tagId">#0</span>
          <span class="tag" id="tagDue">‚è≥</span>
        </div>
        <div class="big" id="cardFront">‚Äî</div>
        <div class="xbig" id="cardBack" hidden>‚Äî</div>
        <div class="controls">
          <button id="btnAudio" class="btn ghost" title="Speak">üîä</button>
          <div class="spacer"></div>
          <button id="btnShow" class="btn brand">üí° <span data-i18n="showAnswer">Javobni ko‚Äòrish</span></button>
        </div>
        <div class="rowcenter" id="gradeRow" hidden>
          <button class="btn danger" data-grade="1">Again</button>
          <button class="btn warn" data-grade="2">Hard</button>
          <button class="btn brand" data-grade="3">Good</button>
          <button class="btn accent" data-grade="4">Easy</button>
        </div>
      </article>
    </section>

    <aside class="panel">
      <h2 id="hQuiz">Test (MCQ)</h2>
      <div class="item">
        <div id="qPrompt" class="big">‚Äî</div>
        <div class="list" id="qChoices"></div>
        <div class="footer" id="qResult"></div>
        <div class="row" style="margin-top:8px">
          <button id="btnNextQ" class="btn brand">Next</button>
          <div class="spacer"></div>
          <span class="muted" id="qProg">0/10</span>
        </div>
      </div>

      <div class="divider"></div>

      <h2 id="hVocab">Lug‚Äòat</h2>
      <div class="list" id="vocabList" aria-live="polite"></div>
      <div class="footer">
        <span class="muted">Maslahat:</span>
        <span id="tip">javobni ko‚Äòrish uchun <span class="kbd">Space</span></span>
      </div>
    </aside>
  </main>

  <footer class="wrap footer">
    ¬© Lingua Trio ‚Äî SRS powered. Built with ‚ù§Ô∏è for Arabic ‚Ä¢ English ‚Ä¢ O‚Äòzbek.
  </footer>

  <script>
  ;(() => {
    // -----------------------------
    // I18N (UI labels)
    // -----------------------------
    const I18N = {
      uz: {
        Flashcards: "Flashcards (SRS)",
        Due: "Muddatli",
        New: "Yangi",
        Learned: "O‚Äòzlashtirilgan",
        Accuracy: "Aniqlik",
        ShowAnswer: "Javobni ko‚Äòrish",
        Test: "Test (MCQ)",
        Vocab: "Lug‚Äòat",
        From: "From",
        Next: "Keyingisi",
        Correct: "To‚Äòg‚Äòri ‚úîÔ∏è",
        Wrong: "Noto‚Äòg‚Äòri ‚ùå",
        Tip: "javobni ko‚Äòrish uchun",
        Space: "Space ni bosing",
      },
      en: {
        Flashcards: "Flashcards (SRS)",
        Due: "Due",
        New: "New",
        Learned: "Learned",
        Accuracy: "Accuracy",
        ShowAnswer: "Show answer",
        Test: "Quiz (MCQ)",
        Vocab: "Vocabulary",
        From: "From",
        Next: "Next",
        Correct: "Correct ‚úîÔ∏è",
        Wrong: "Wrong ‚ùå",
        Tip: "press",
        Space: "Space to reveal",
      },
      tr: {
        Flashcards: "Kartlar (SRS)",
        Due: "S√ºreli",
        New: "Yeni",
        Learned: "√ñƒürenilen",
        Accuracy: "Doƒüruluk",
        ShowAnswer: "Cevabƒ± g√∂ster",
        Test: "Test (MCQ)",
        Vocab: "S√∂zl√ºk",
        From: "Kaynak",
        Next: "Sonraki",
        Correct: "Doƒüru ‚úîÔ∏è",
        Wrong: "Yanlƒ±≈ü ‚ùå",
        Tip: "g√∂stermek i√ßin",
        Space: "Bo≈üluk tu≈üuna bas",
      }
    };

    // -----------------------------
    // Seed data (basic phrases)
    // -----------------------------
    const TERMS = [
      {id:1,  cat:"basic", ar:"ŸÖÿ±ÿ≠ÿ®ÿß",            en:"hello",                uz:"salom"},
      {id:2,  cat:"basic", ar:"ŸÉŸäŸÅ ÿ≠ÿßŸÑŸÉÿü",        en:"how are you?",         uz:"qalaysiz?"},
      {id:3,  cat:"basic", ar:"ÿ¥ŸÉÿ±ÿß",             en:"thank you",            uz:"rahmat"},
      {id:4,  cat:"basic", ar:"ŸÜÿπŸÖ",              en:"yes",                  uz:"ha"},
      {id:5,  cat:"basic", ar:"ŸÑÿß",               en:"no",                   uz:"yo‚Äòq"},
      {id:6,  cat:"basic", ar:"ŸÖŸÜ ŸÅÿ∂ŸÑŸÉ",          en:"please",               uz:"iltimos"},
      {id:7,  cat:"basic", ar:"ÿ£ŸáŸÑÿß Ÿàÿ≥ŸáŸÑÿß",       en:"welcome",              uz:"xush kelibsiz"},
      {id:8,  cat:"basic", ar:"ŸÖÿπ ÿßŸÑÿ≥ŸÑÿßŸÖÿ©",       en:"goodbye",              uz:"xayr"},
      {id:9,  cat:"basic", ar:"ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ±",       en:"good morning",         uz:"xayrli tong"},
      {id:10, cat:"basic", ar:"ŸÖÿ≥ÿßÿ° ÿßŸÑÿÆŸäÿ±",       en:"good evening",         uz:"xayrli kech"},
      {id:11, cat:"travel",ar:"ÿ£ŸäŸÜ ÿßŸÑÿ≠ŸÖÿßŸÖÿü",      en:"where is the bathroom?", uz:"hammom qayerda?"},
      {id:12, cat:"travel",ar:"ŸÉŸÖ ÿßŸÑÿ≥ÿπÿ±ÿü",        en:"how much is it?",      uz:"narxi qancha?"},
      {id:13, cat:"travel",ar:"ÿ£ŸÜÿß ŸÑÿß ÿ£ŸÅŸáŸÖ",      en:"I don't understand",   uz:"tushunmadim"},
      {id:14, cat:"travel",ar:"ÿ™ÿ≠ÿØÿ´ ÿ®ÿ®ÿ∑ÿ°",        en:"speak slowly",         uz:"sekin gapiring"},
      {id:15, cat:"time",  ar:"ÿßŸÑŸäŸàŸÖ",            en:"today",                uz:"bugun"},
      {id:16, cat:"time",  ar:"ÿ∫ÿØŸãÿß",             en:"tomorrow",             uz:"ertaga"},
      {id:17, cat:"time",  ar:"ÿßŸÑÿ¢ŸÜ",             en:"now",                  uz:"hozir"},
      {id:18, cat:"people",ar:"ÿµÿØŸäŸÇ",             en:"friend",               uz:"do‚Äòst"},
      {id:19, cat:"people",ar:"ÿπÿßÿ¶ŸÑÿ©",            en:"family",               uz:"oila"},
      {id:20, cat:"people",ar:"ÿ∑ŸÅŸÑ",              en:"child",                uz:"bola"},
      {id:21, cat:"food",  ar:"ŸÖÿßÿ°",              en:"water",                uz:"suv"},
      {id:22, cat:"food",  ar:"ÿÆÿ®ÿ≤",              en:"bread",                uz:"non"},
      {id:23, cat:"food",  ar:"ÿ¥ÿßŸä",              en:"tea",                  uz:"choy"},
      {id:24, cat:"food",  ar:"ŸÇŸáŸàÿ©",             en:"coffee",               uz:"qahva"}
    ];

    // -----------------------------
    // Persistence
    // -----------------------------
    const STORAGE_KEY = "lingua-trio-v1";
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

    // -----------------------------
    // SRS model (SM-2 simplified)
    // -----------------------------
    function newCardState(id){
      // n: repetitions, ef: ease factor, ivl: interval (days), due: timestamp
      return { id, n:0, ef:2.5, ivl:0, due: Date.now(), lapses:0, seen:0, correct:0 };
    }
    function gradeCard(cs, q){
      // q: 1-4 (Again, Hard, Good, Easy)
      cs.seen++;
      const good = q>=3 ? 1 : 0;
      cs.correct += good;

      const now = Date.now();
      if(q<=1){ // Again
        cs.n = 0;
        cs.ivl = 0.5; // 12 hours
        cs.ef = Math.max(1.3, cs.ef - 0.3);
        cs.lapses++;
      } else {
        if(cs.n===0){
          cs.ivl = (q===3?1:2); // first interval days
          cs.n = 1;
        } else if(cs.n===1){
          cs.ivl = (q===3?3:4);
          cs.n = 2;
        } else {
          // EF update
          const dq = (q===3?4:5); // map Good->4, Easy->5
          cs.ef = Math.max(1.3, cs.ef + (0.1 - (5-dq)*(0.08 + (5-dq)*0.02)));
          cs.ivl = Math.ceil(cs.ivl * cs.ef);
          cs.n++;
        }
      }
      cs.due = now + cs.ivl*24*60*60*1000; // days -> ms
      return cs;
    }

    // -----------------------------
    // App State
    // -----------------------------
    const state = loadState() || {
      uiLang: "uz",
      from: "uz",
      to: "ar",
      srs: Object.fromEntries(TERMS.map(t=>[t.id, newCardState(t.id)])),
      stats: { correct:0, total:0 },
      quiz: { idx:0, total:10 }
    };
    // Ensure all cards exist
    for(const t of TERMS){
      if(!state.srs[t.id]) state.srs[t.id] = newCardState(t.id);
    }

    // -----------------------------
    // Helpers
    // -----------------------------
    const el = id => document.getElementById(id);
    function fmtPct(n){ return (isNaN(n)?0:n).toFixed(0) + "%"; }
    function sample(arr, n){
      const out=[], used=new Set();
      while(out.length<n && used.size<arr.length){
        const i = Math.floor(Math.random()*arr.length);
        if(!used.has(i)){ out.push(arr[i]); used.add(i); }
      }
      return out;
    }
    function langText(term, lang){
      return term[lang];
    }
    function isRTL(lang){ return lang==="ar"; }
    function dueCount(){
      const now = Date.now();
      return TERMS.filter(t=> state.srs[t.id].due <= now).length;
    }
    function newCount(){
      return TERMS.filter(t=> state.srs[t.id].n===0).length;
    }
    function learnedCount(){
      return TERMS.filter(t=> state.srs[t.id].n>=2).length;
    }

    // -----------------------------
    // UI Binding
    // -----------------------------
    const fromSel = el("fromLang");
    const toSel   = el("toLang");
    const uiSel   = el("uiLang");
    const sDue = el("sDue"), sNew=el("sNew"), sLearned=el("sLearned"), sAcc=el("sAcc");
    const sDueL=el("sDueL"), sNewL=el("sNewL"), sLearnedL=el("sLearnedL"), sAccL=el("sAccL");
    const hFlash=el("hFlash"), hQuiz=el("hQuiz"), hVocab=el("hVocab");
    const lblFrom=el("lblFrom"), lblUi=el("lblUi"), btnShow=el("btnShow");
    const cardFront=el("cardFront"), cardBack=el("cardBack"), gradeRow=el("gradeRow"), btnAudio=el("btnAudio");
    const tagCategory=el("tagCategory"), tagId=el("tagId"), tagDue=el("tagDue");
    const qPrompt=el("qPrompt"), qChoices=el("qChoices"), qResult=el("qResult"), qProg=el("qProg"), btnNextQ=el("btnNextQ");
    const vocabList=el("vocabList");
    const tip=el("tip");

    // Apply persisted selections
    uiSel.value = state.uiLang;
    fromSel.value = state.from;
    toSel.value = state.to;
    if(fromSel.value===toSel.value){
      toSel.value = fromSel.value==="ar" ? "en" : "ar";
    }

    // I18N apply
    function applyI18N(){
      const L = I18N[state.uiLang] || I18N.uz;
      hFlash.textContent = L.Flashcards;
      sDueL.textContent = L.Due;
      sNewL.textContent = L.New;
      sLearnedL.textContent = L.Learned;
      sAccL.textContent = L.Accuracy;
      hQuiz.textContent = L.Test;
      hVocab.textContent = L.Vocab;
      lblFrom.textContent = L.From;
      btnShow.querySelector("[data-i18n='showAnswer']").textContent = L.ShowAnswer;
      btnNextQ.textContent = L.Next;
      tip.innerHTML = `${L.Tip} <span class="kbd">Space</span> ${L.Space}`;
      document.documentElement.lang = state.uiLang;
    }

    // Stats render
    function renderStats(){
      sDue.textContent = dueCount();
      sNew.textContent = newCount();
      sLearned.textContent = learnedCount();
      const {correct,total} = state.stats;
      sAcc.textContent = total ? fmtPct(100*correct/total) : "‚Äî";
    }

    // Current card selection (due first, else nearest due)
    let current = null;
    function pickCard(){
      const now = Date.now();
      const due = TERMS.filter(t=> state.srs[t.id].due <= now);
      if(due.length>0) return due.sort((a,b)=> state.srs[a.id].due - state.srs[b.id].due)[0];
      return TERMS.slice().sort((a,b)=> state.srs[a.id].due - state.srs[b.id].due)[0];
    }

    function renderCard(){
      current = pickCard();
      const cs = state.srs[current.id];
      const frontText = langText(current, state.from);
      const backMain  = langText(current, state.to);
      const alt = ["ar","en","uz"].filter(x=> x!==state.from && x!==state.to);
      const backAlt = langText(current, alt[0]);

      const rTL = isRTL(state.from);
      const rTLBack = isRTL(state.to);
      cardFront.dir = rTL ? "rtl" : "ltr";
      cardBack.dir  = rTLBack ? "rtl" : "ltr";

      cardFront.textContent = frontText;
      cardBack.innerHTML = `<div>${backMain}</div><div class="muted" style="margin-top:8px">${backAlt}</div>`;
      tagCategory.textContent = current.cat;
      tagId.textContent = "#" + current.id;
      const dueIn = Math.max(0, Math.round((cs.due - Date.now())/3600000));
      tagDue.textContent = dueIn===0 ? "‚è≥ due" : `üóì in ${dueIn}h`;
      cardBack.hidden = true;
      gradeRow.hidden = true;
      btnShow.disabled = false;

      // audio availability
      btnAudio.disabled = !canSpeak(state.to);
    }

    // Show answer
    btnShow.addEventListener("click", () => {
      cardBack.hidden = false;
      gradeRow.hidden = false;
      btnShow.disabled = true;
    });

    // Keyboard: Space to reveal, 1..4 to grade
    window.addEventListener("keydown",(e)=>{
      if(e.key===" "){ e.preventDefault(); if(btnShow.disabled===false) btnShow.click(); }
      if(!gradeRow.hidden && ["1","2","3","4"].includes(e.key)){
        grade(+e.key);
      }
    });

    // Grade handlers
    gradeRow.querySelectorAll("button[data-grade]").forEach(b=>{
      b.addEventListener("click", ()=> grade(+b.dataset.grade));
    });
    function grade(q){
      const cs = state.srs[current.id];
      gradeCard(cs, q);
      state.stats.total++;
      if(q>=3) state.stats.correct++;
      saveState(state);
      renderStats();
      renderCard();
      renderVocab();
    }

    // -----------------------------
    // Quiz (MCQ)
    // -----------------------------
    function newQuestion(){
      const pool = TERMS;
      const q = sample(pool, 1)[0];
      const correct = langText(q, state.to);
      const prompt  = langText(q, state.from);
      const distractors = sample(pool.filter(t=>t.id!==q.id), 3).map(t=> langText(t, state.to));
      const choices = sample([correct, ...distractors], 4);
      qPrompt.dir = isRTL(state.from) ? "rtl" : "ltr";
      qPrompt.textContent = prompt;
      qChoices.innerHTML = "";
      qResult.textContent = "";
      choices.forEach(ch=>{
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = ch;
        btn.dir = isRTL(state.to) ? "rtl" : "ltr";
        btn.addEventListener("click", ()=>{
          if(btn.dataset.clicked) return;
          btn.dataset.clicked = "1";
          if(ch===correct){
            qResult.textContent = I18N[state.uiLang].Correct;
            qResult.className = "footer success";
          } else {
            qResult.textContent = I18N[state.uiLang].Wrong + ` ‚Äî ${correct}`;
            qResult.className = "footer danger-t";
          }
        });
        qChoices.appendChild(btn);
      });
      qProg.textContent = `${state.quiz.idx+1}/${state.quiz.total}`;
    }
    btnNextQ.addEventListener("click", ()=>{
      state.quiz.idx = (state.quiz.idx+1) % state.quiz.total;
      newQuestion();
    });

    // -----------------------------
    // Vocab list
    // -----------------------------
    function renderVocab(){
      vocabList.innerHTML = "";
      const f = state.from, t = state.to;
      const now = Date.now();
      TERMS.forEach(term=>{
        const cs = state.srs[term.id];
        const due = cs.due <= now;
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="muted" style="font-size:12px">${term.cat} ‚Ä¢ #${term.id}</div>
          <div class="big" dir="${isRTL(f)?"rtl":"ltr"}">${langText(term, f)}</div>
          <div class="xbig muted" dir="${isRTL(t)?"rtl":"ltr"}">${langText(term, t)}</div>
          <div class="row" style="margin-top:8px;gap:8px">
            <button class="btn ghost speak" ${canSpeak(t)?"":"disabled"} data-lang="${t}" data-id="${term.id}">üîä</button>
            <span class="tag">${due?"‚è≥ due":"üóì"}</span>
            <span class="tag">EF ${state.srs[term.id].ef.toFixed(2)}</span>
            <span class="tag">n ${state.srs[term.id].n}</span>
          </div>
        `;
        vocabList.appendChild(div);
      });
      vocabList.querySelectorAll(".speak").forEach(b=>{
        b.addEventListener("click", ()=>{
          const id = +b.dataset.id;
          const lang = b.dataset.lang;
          const term = TERMS.find(t=>t.id===id);
          speak(langText(term, lang), lang);
        });
      });
    }

    // -----------------------------
    // Speech
    // -----------------------------
    let VOICES = [];
    function loadVoices(){
      VOICES = speechSynthesis.getVoices();
    }
    if("speechSynthesis" in window){
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    function findVoice(lang){
      if(!VOICES || !VOICES.length) return null;
      // try exact, then startsWith
      return VOICES.find(v=> v.lang===lang) || VOICES.find(v=> v.lang && v.lang.toLowerCase().startsWith(lang.split('-')[0]));
    }
    function canSpeak(lang){
      if(!("speechSynthesis" in window)) return false;
      // Attempt to find any reasonable voice
      const mapping = { ar:"ar-SA", en:"en-US", uz:"uz-UZ" };
      const voice = findVoice(mapping[lang] || lang);
      return !!voice;
    }
    function speak(text, lang){
      try{
        const mapping = { ar:"ar-SA", en:"en-US", uz:"uz-UZ" };
        const voice = findVoice(mapping[lang] || lang);
        if(!voice) return;
        const u = new SpeechSynthesisUtterance(text);
        u.voice = voice;
        u.lang = voice.lang;
        u.rate = 0.95;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(u);
      }catch(e){}
    }
    btnAudio.addEventListener("click", ()=>{
      const alt = ["ar","en","uz"].filter(x=> x!==state.from && x!==state.to);
      // Read target if possible, else alternate, else from
      if(canSpeak(state.to)) speak(cardBack.textContent.trim(), state.to);
      else if(canSpeak(alt[0])) speak(cardBack.textContent.trim(), alt[0]);
      else if(canSpeak(state.from)) speak(cardFront.textContent.trim(), state.from);
    });

    // -----------------------------
    // Import/Export
    // -----------------------------
    el("btnExport").addEventListener("click", ()=>{
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "lingua-trio-backup.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });
    el("imp").addEventListener("change", (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const imported = JSON.parse(reader.result);
          if(imported && imported.srs && imported.stats){
            Object.assign(state, imported);
            saveState(state);
            applyI18N();
            renderStats();
            renderCard();
            renderVocab();
            newQuestion();
            alert("Import done ‚úîÔ∏è");
          } else alert("Invalid file ‚ùå");
        }catch{
          alert("Invalid JSON ‚ùå");
        }
      };
      reader.readAsText(file);
    });

    // -----------------------------
    // UI events (selectors)
    // -----------------------------
    uiSel.addEventListener("change", ()=>{
      state.uiLang = uiSel.value; saveState(state); applyI18N();
    });
    function ensureDifferent(){
      if(fromSel.value===toSel.value){
        // auto switch "to"
        toSel.value = ["ar","en","uz"].find(x=> x!==fromSel.value) || "ar";
      }
    }
    fromSel.addEventListener("change", ()=>{
      state.from = fromSel.value; ensureDifferent(); state.to = toSel.value; saveState(state); renderCard(); renderVocab(); newQuestion();
    });
    toSel.addEventListener("change", ()=>{
      ensureDifferent(); state.to = toSel.value; state.from = fromSel.value; saveState(state); renderCard(); renderVocab(); newQuestion();
    });

    // -----------------------------
    // Init
    // -----------------------------
    function init(){
      applyI18N();
      renderStats();
      renderCard();
      renderVocab();
      newQuestion();
    }
    init();
  })();
  </script>
</body>
</html>